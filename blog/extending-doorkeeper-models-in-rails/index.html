<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" Content-Encoding="gzip">
    <meta name="description" content="Extending Doorkeeper models in Ruby on Rails using class_eval. Associations,
validations, new functionality, etc...">
    <meta name="author" content="Alberto Grespan">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="QWmLu6t80Hd6FFgS7MaFl_UMcFLXqOLwd08_u-HXzsk">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@albertogg">
    <meta name="twitter:title" content="Extending Doorkeeper models in Rails">
    <meta name="twitter:description" content="Extending Doorkeeper models in Ruby on Rails using class_eval. Associations,
validations, new functionality, etc...">
    <meta name="twitter:creator" content="@albertogg">
    <meta name="twitter:image:src" content="https://www.gravatar.com/avatar/006ef14fba8fadd40053ecda5039deb2.png?s=250">
    <meta name="twitter:domain" content="albertogrespan.com">
    <title>Extending Doorkeeper models in Rails &ndash; Alberto Grespan</title>
    <link href="https://fonts.googleapis.com/css?family=Merriweather:300,700,900" rel="stylesheet">
    
    <link rel="stylesheet" type="text/css" href="https://albertogrespan.com/site/scss/style.css">
  </head>
  <body>
    <div id="content-wrapper">
      <div class="header">
  <header class="container">
    <h1 class="name">
      <a href="https://albertogrespan.com">Alberto Grespan</a>
    </h1> 
    <ul class="menu">
      <li><a href="https://albertogrespan.com/about/">About</a></li>
      <li><a href="https://albertogrespan.com/resume/">Resume</a></li>
    </ul> 
  </header> 
</div> 

      
  <div id="post" class="post">
    <h1>Extending Doorkeeper models in Rails</h1>
    <div class="date">
      <p>January 15, 2015</p>
    </div> 
    <blockquote>
<p>tl;dr use <code>class_eval</code> to extend Doorkeeper models functionality in runtime.</p>
</blockquote>

<p>A few weeks ago at work, we were extending our very basic OAuth2 provider by
adding the possibility to either login with Google OAuth2 or with our own. With
that we also did a role based level of authorization, nothing complex&hellip; but, as
we are using Doorkeeper for the OAuth2 we needed new validations, associations
and a couple of new methods in one of their models to fulfill our needs. To
achieve this we used <code>class_eval</code> inside a Rails initializer that allowed us to
extend the model in runtime without touching the code inside the gem.</p>

<p>Let&rsquo;s take a look at it.</p>

<pre><code># config/initializers/doorkeeper_patch.rb
# Log the Doorkeeper extension
Rails.logger.info &quot;Extending Doorkeeper from config/initializer/doorkeeper_patch.rb&quot;

Doorkeeper::Application.class_eval do
  has_and_belongs_to_many :roles, foreign_key: &quot;oauth_application_id&quot;

  validates_uniqueness_of :name

  # keep adding any other methods, validations, relations here...
end
</code></pre>

<p>Note that there is a <code>Rails.logger</code> at the beginning of the file as a
notification that there is a &ldquo;monkey patch&rdquo; in Doorkeeper, this may be helpful
when debugging latter, after that, we proceed to add whatever was needed to that
model as if we were inside that Rails model.</p>

<p>You can do the same thing to the other Doorkeeper models or libraries.</p>

<hr />

<p>That&rsquo;s all, pretty easily we manage to accomplish what we needed by extending
the models in runtime using <code>class_eval</code>.</p>

<p>Thanks for reading!</p>

    <div class="closing">
      <div>
       By <a href="https://twitter.com/albertogg" class="twitter-follow-link">@albertogg</a>
      </div>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://albertogrespan.com/blog/extending-doorkeeper-models-in-rails/" data-text="Extending Doorkeeper models in Rails" data-via="albertogg">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div> 
  </div> 

    </div> 
    <footer id="footer">
  <div class="container">
    <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>
    <p>2012 &#151; 2020 albertogrespan.com</p>
  </div> 
</footer> 

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-29129831-1', 'albertogrespan.com');
      ga('require', 'linkid', 'linkid.js');
      ga('send', 'pageview');
    </script>
  </body>
</html>
